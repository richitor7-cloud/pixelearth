<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Píxeles por Equipos</title>

    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin="" defer></script>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow: hidden; }
        #map { height: 100vh; width: 100vw; background-color: #f0f0f0; cursor: crosshair; }
        .leaflet-popup-content-wrapper { border-radius: 12px; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); }
        .leaflet-popup-content { margin: 15px; font-size: 14px; width: auto !important; }
        .leaflet-popup-tip { background: rgba(255, 255, 255, 0.85); }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Team Selection Modal -->
    <div id="team-selection-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[4000]" style="display: none;">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center max-w-sm w-full mx-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Elige tu Equipo</h2>
            <p class="text-gray-600 mb-6">El color con el que pintes dependerá de tu equipo.</p>
            <div class="flex flex-col gap-4">
                <button id="select-red-team" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-transform transform hover:scale-105">
                    Equipo Rojo
                </button>
                <button id="select-blue-team" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105">
                    Equipo Azul
                </button>
            </div>
        </div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-[3000]">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-gray-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373,0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042,1.135,5.824,3,7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg font-medium text-gray-700">Cargando mapa y píxeles...</p>
        </div>
    </div>
    
    <!-- Paint Actions Panel -->
    <div id="paint-actions-panel" class="fixed bottom-4 left-1/2 -translate-x-1/2 w-full max-w-md z-[2000] p-2" style="display: none;">
        <div class="bg-white/80 backdrop-blur-md shadow-2xl rounded-2xl p-4 flex items-center gap-3">
             <button id="bottom-cancel-btn" class="flex-1 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
             <button id="bottom-confirm-btn" class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Confirmar</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, serverTimestamp, setLogLevel, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- CONFIGURATION ---
        const firebaseConfig = {
    apiKey: "AIzaSyBFJ9wp_lQcY2qeZOid7vSqhN_TF14Qku4",
    authDomain: "earth-dd5c6.firebaseapp.com",
    projectId: "earth-dd5c6",
    storageBucket: "earth-dd5c6.firebasestorage.app",
    messagingSenderId: "118865590559",
    appId: "1:118865590559:web:87123635d50db48934d82a"
  };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pixel-map';
        
        const PIXEL_SIZE_METERS = 20;
        const TEAM_COLORS = {
            red: '#FF4136',
            blue: '#0074D9'
        };
        const GRID_VISIBILITY_ZOOM_LEVEL = 15;

        // --- STATE ---
        let map;
        let drawnLayers = new Map();
        let pixelDataStore = new Map();
        let currentPopup = null;
        let db, auth, userId;
        let previewPixel = null;
        let multiSelection = new Map();
        let selectionLayerGroup = null;
        let inspectionSelectionLayer = null;
        let isInPaintMode = false;
        let userTeam = null;
        let activeColor = null;
        let pendingAction = null;

        // --- DOM ELEMENTS ---
        const loader = document.getElementById('loader');
        const teamSelectionModal = document.getElementById('team-selection-modal');
        const paintActionsPanel = document.getElementById('paint-actions-panel');
        const bottomConfirmBtn = document.getElementById('bottom-confirm-btn');
        const bottomCancelBtn = document.getElementById('bottom-cancel-btn');

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            initializeTeamSelection();
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                await authenticateUser();
                initializeMap();
                listenForPixels();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loader.innerText = "Error de conexión. Por favor, refresca la página.";
            }
        });

        async function authenticateUser() {
            return new Promise((resolve) => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        resolve(user);
                    } else {
                        try {
                           if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) { console.error("Sign-in failed:", error); }
                    }
                });
            });
        }

        function initializeTeamSelection() {
            document.getElementById('select-red-team').addEventListener('click', () => selectTeam('red'));
            document.getElementById('select-blue-team').addEventListener('click', () => selectTeam('blue'));
        }

        function selectTeam(team) {
            userTeam = team;
            activeColor = TEAM_COLORS[team];
            teamSelectionModal.style.display = 'none';
            if (typeof pendingAction === 'function') {
                pendingAction();
                pendingAction = null; 
            }
        }
        
        function initializeMap() {
            map = L.map('map', { 
                closePopupOnClick: true,
                renderer: L.canvas({ tolerance: 0.1 })
            }).setView([20, 0], 3);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 22, attribution: '&copy; OpenStreetMap'
            }).addTo(map);
            selectionLayerGroup = L.layerGroup().addTo(map);
            map.on('click', handleMapClick);
            map.on('mousemove', handleMouseMove);
            map.on('mouseout', handleMouseOut);
            map.on('zoomend', handleZoomEnd);
            bottomConfirmBtn.addEventListener('click', handleConfirmPaint);
            bottomCancelBtn.addEventListener('click', cancelPaintMode);
        }

        // --- FIRESTORE ---
        function listenForPixels() {
            const pixelsCollection = collection(db, `/artifacts/${appId}/public/data/pixels`);
            onSnapshot(pixelsCollection, (snapshot) => {
                // **BUG FIX**: Hide the loader as soon as we get the first response from the server,
                // even if the snapshot is empty. This prevents getting stuck on the loading screen.
                loader.style.display = 'none';
                
                snapshot.docChanges().forEach((change) => {
                    const pixelId = change.doc.id;
                    if (change.type === "removed") {
                        if (drawnLayers.has(pixelId)) {
                            map.removeLayer(drawnLayers.get(pixelId));
                            drawnLayers.delete(pixelId);
                            pixelDataStore.delete(pixelId);
                        }
                    } else {
                        const pixelData = change.doc.data();
                        pixelDataStore.set(pixelId, pixelData);
                        drawOrUpdatePixel(pixelId, pixelData);
                    }
                });
            }, (error) => console.error("Error listening to pixel data:", error));
        }
        
        function clearAllVisuals() {
            if (inspectionSelectionLayer) {
                map.removeLayer(inspectionSelectionLayer);
                inspectionSelectionLayer = null;
            }
            if (currentPopup) {
                map.closePopup(currentPopup);
                currentPopup = null;
            }
            handleMouseOut();
        }

        // --- SYMMETRICAL GRID LOGIC ---
        function createSymmetricalGrid(bounds) {
            const rects = [];
            const options = { color: 'black', weight: 0, fillColor: 'black', fillOpacity: 1, interactive: false };
            const nw = bounds.getNorthWest(), ne = bounds.getNorthEast(), sw = bounds.getSouthWest(), se = bounds.getSouthEast();
            const latSpan = Math.abs(bounds.getNorth() - bounds.getSouth()), lngSpan = Math.abs(bounds.getEast() - bounds.getWest());
            const segmentFraction = 0.25;
            const latSegment = latSpan * segmentFraction, lngSegment = lngSpan * segmentFraction;
            const thicknessMeters = 1.0;
            const thicknessLat = thicknessMeters / 111132; 
            const centerLat = bounds.getCenter().lat;
            const thicknessLng = thicknessMeters / (111320 * Math.cos(centerLat * Math.PI / 180));
            rects.push(L.rectangle(L.latLngBounds([nw.lat - thicknessLat / 2, nw.lng - thicknessLng / 2], [nw.lat + thicknessLat / 2, nw.lng + lngSegment]), options));
            rects.push(L.rectangle(L.latLngBounds([nw.lat - latSegment, nw.lng - thicknessLng / 2], [nw.lat + thicknessLat / 2, nw.lng + thicknessLng / 2]), options));
            rects.push(L.rectangle(L.latLngBounds([ne.lat - thicknessLat / 2, ne.lng - lngSegment], [ne.lat + thicknessLat / 2, ne.lng + thicknessLng / 2]), options));
            rects.push(L.rectangle(L.latLngBounds([ne.lat - latSegment, ne.lng - thicknessLng / 2], [ne.lat + thicknessLat / 2, ne.lng + thicknessLng / 2]), options));
            rects.push(L.rectangle(L.latLngBounds([sw.lat - thicknessLat / 2, sw.lng - thicknessLng / 2], [sw.lat + thicknessLat / 2, sw.lng + lngSegment]), options));
            rects.push(L.rectangle(L.latLngBounds([sw.lat - thicknessLat / 2, sw.lng - thicknessLng / 2], [sw.lat + latSegment, sw.lng + thicknessLng / 2]), options));
            rects.push(L.rectangle(L.latLngBounds([se.lat - thicknessLat / 2, se.lng - lngSegment], [se.lat + thicknessLat / 2, se.lng + thicknessLng / 2]), options));
            rects.push(L.rectangle(L.latLngBounds([se.lat - thicknessLat / 2, se.lng - thicknessLng / 2], [se.lat + latSegment, se.lng + thicknessLng / 2]), options));
            return L.layerGroup(rects);
        }

        // --- MAP INTERACTION & LOGIC ---
        function handleMapClick(e) {
            if (isInPaintMode) {
                handleMultiSelectionClick(e.latlng);
            } else {
                handleInspectClick(e);
            }
        }

        function handleInspectClick(e) {
            clearAllVisuals();
            const pixelBounds = getPixelBounds(e.latlng);
            const pixelId = getPixelIdFromBounds(pixelBounds);
            if (map.getZoom() >= GRID_VISIBILITY_ZOOM_LEVEL) {
                 inspectionSelectionLayer = createSymmetricalGrid(pixelBounds).addTo(map);
            }
            const popupContentElement = createPopupContent(pixelId, pixelBounds);
            currentPopup = L.popup({ minWidth: 280 })
                .setLatLng(pixelBounds.getCenter())
                .setContent(popupContentElement)
                .openOn(map)
                .on('remove', () => {
                    if (inspectionSelectionLayer) {
                        map.removeLayer(inspectionSelectionLayer);
                        inspectionSelectionLayer = null;
                    }
                });
        }

        function handleMultiSelectionClick(latlng) {
            const pixelBounds = getPixelBounds(latlng);
            const pixelId = getPixelIdFromBounds(pixelBounds);
            if (multiSelection.has(pixelId)) {
                 const { visualLayer } = multiSelection.get(pixelId);
                 selectionLayerGroup.removeLayer(visualLayer);
                 multiSelection.delete(pixelId);
            } else {
                const fillLayer = L.rectangle(pixelBounds, { weight: 1, color: activeColor, fillOpacity: 1, fillColor: activeColor, interactive: false });
                const borderLayer = createSymmetricalGrid(pixelBounds);
                const visualLayer = L.layerGroup([fillLayer, borderLayer]);
                selectionLayerGroup.addLayer(visualLayer);
                multiSelection.set(pixelId, { bounds: pixelBounds, visualLayer });
            }
        }
        
        function handleZoomEnd() {
            if (map.getZoom() < GRID_VISIBILITY_ZOOM_LEVEL) {
                if (previewPixel) {
                    map.removeLayer(previewPixel);
                    previewPixel = null;
                }
            }
        }

        function handleMouseMove(e) {
             if (!map) return;
             if (map.getZoom() < GRID_VISIBILITY_ZOOM_LEVEL) {
                 handleMouseOut();
                 return;
             }
             if (previewPixel) {
                map.removeLayer(previewPixel);
             }
             const pixelBounds = getPixelBounds(e.latlng);
             previewPixel = createSymmetricalGrid(pixelBounds).addTo(map);
        }

        function handleMouseOut() {
            if (previewPixel) {
                map.removeLayer(previewPixel);
                previewPixel = null;
            }
        }
        
        function getPixelInfoHtml(pixelId) {
            const data = pixelDataStore.get(pixelId);
            if (data) {
                const teamName = data.team === 'red' ? 'Rojo' : 'Azul';
                const teamColor = data.team === 'red' ? 'text-red-600' : 'text-blue-600';
                const creationDate = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : 'N/A';
                return `<div class="mb-3 space-y-1 text-sm">
                        <p><strong>Autor:</strong> <span class="font-mono text-xs break-all">${data.author}</span></p>
                        <p><strong>Equipo:</strong> <span class="font-bold ${teamColor}">${teamName}</span></p>
                        <p><strong>Fecha:</strong> ${creationDate}</p>
                    </div>`;
            }
            return `<div class="text-center text-gray-500 italic mb-3">Píxel vacío</div>`;
        }
        
        function createPopupContent(pixelId, pixelBounds) {
            const container = document.createElement('div');
            container.innerHTML = getPixelInfoHtml(pixelId);
            const paintButton = document.createElement('button');
            paintButton.className = 'w-full text-white font-bold py-2 px-4 rounded-lg transition-colors';
            paintButton.textContent = 'Pintar';
            paintButton.style.backgroundColor = activeColor ? activeColor : '#6B7280';

            paintButton.addEventListener('click', () => {
                if (userTeam) {
                    enterPaintMode(pixelId, pixelBounds);
                } else {
                    pendingAction = () => enterPaintMode(pixelId, pixelBounds);
                    teamSelectionModal.style.display = 'flex';
                }
            });
            
            container.appendChild(paintButton);
            return container;
        }

        function enterPaintMode(pixelId, pixelBounds) {
            clearAllVisuals();
            isInPaintMode = true;
            paintActionsPanel.style.display = 'block';
            handleMultiSelectionClick(pixelBounds.getCenter());
        }

        function cancelPaintMode() {
            isInPaintMode = false;
            multiSelection.forEach(({ visualLayer }) => selectionLayerGroup.removeLayer(visualLayer));
            multiSelection.clear();
            paintActionsPanel.style.display = 'none';
        }
        
        async function handleConfirmPaint() {
            if (multiSelection.size === 0) {
                cancelPaintMode();
                return;
            }
            bottomConfirmBtn.textContent = 'Pintando...';
            bottomConfirmBtn.disabled = true;

            const batch = writeBatch(db);
            const pixelsToPaint = new Map(multiSelection); 
            
            pixelsToPaint.forEach(({ bounds }, pixelId) => {
                const serverData = {
                    bounds: { south: bounds.getSouth(), west: bounds.getWest(), north: bounds.getNorth(), east: bounds.getEast() },
                    color: activeColor,
                    team: userTeam,
                    author: userId,
                    createdAt: serverTimestamp()
                };
                const docRef = doc(db, `/artifacts/${appId}/public/data/pixels`, pixelId);
                batch.set(docRef, serverData);
            });
            
            cancelPaintMode(); 
            
            try {
                await batch.commit(); 
            } catch (error) {
                console.error("Error painting pixels:", error);
            } finally {
                bottomConfirmBtn.textContent = 'Confirmar';
                bottomConfirmBtn.disabled = false;
            }
        }

        function getPixelBounds(latlng) {
            const projectedPoint = L.CRS.EPSG3857.project(latlng);
            const snappedX = Math.floor(projectedPoint.x / PIXEL_SIZE_METERS) * PIXEL_SIZE_METERS;
            const snappedY = Math.floor(projectedPoint.y / PIXEL_SIZE_METERS) * PIXEL_SIZE_METERS;
            const c1 = L.point(snappedX, snappedY), c2 = L.point(snappedX + PIXEL_SIZE_METERS, snappedY + PIXEL_SIZE_METERS);
            const b1 = L.CRS.EPSG3857.unproject(c1), b2 = L.CRS.EPSG3857.unproject(c2);
            return L.latLngBounds(b1, b2);
        }

        function getPixelIdFromBounds(bounds) {
            return `${bounds.getSouth()}_${bounds.getWest()}`.replace(/\./g, 'd');
        }
        
        function drawOrUpdatePixel(id, data) {
            if (drawnLayers.has(id)) {
                map.removeLayer(drawnLayers.get(id));
                drawnLayers.delete(id);
            }
            if (!data || !data.bounds || !data.color) {
                return; 
            }
            const dataBounds = L.latLngBounds([data.bounds.south, data.bounds.west], [data.bounds.north, data.bounds.east]);
            const style = { color: data.color, weight: 1, fillOpacity: 1, fillColor: data.color, interactive: false };
            const pixelRectangle = L.rectangle(dataBounds, style).addTo(map);
            drawnLayers.set(id, pixelRectangle);
        }
    </script>
</body>
</html>



